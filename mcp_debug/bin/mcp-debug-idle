#!/usr/bin/env bash
set -euo pipefail

LOG_DIR="${LOG_DIR:-/workspace/logs}"
HEARTBEAT_INTERVAL="${HEARTBEAT_INTERVAL:-30}"
TAIL_FILES="${TAIL_FILES:-}"
TTYD_ENABLED="${TTYD_ENABLED:-true}"
TTYD_PORT="${TTYD_PORT:-7681}"
TTYD_EXTRA_ARGS="${TTYD_EXTRA_ARGS:-}"
SSH_ENABLED="${SSH_ENABLED:-auto}"
SSH_PORT="${SSH_PORT:-22}"
SSH_AUTHORIZED_KEYS_FILE="${SSH_AUTHORIZED_KEYS_FILE:-/workspace/localdata/ssh/authorized_keys}"
SSH_AUTHORIZED_KEYS="${SSH_AUTHORIZED_KEYS:-}"
SSH_STATUS="disabled"
SSH_CONFIG_PATH="${SSH_CONFIG_PATH:-/etc/ssh/sshd_config.d/99-mcp-debug.conf}"
mkdir -p "$LOG_DIR"

cleanup() {
  if [[ -n "${TAIL_PID:-}" ]]; then
    kill "$TAIL_PID" >/dev/null 2>&1 || true
  fi
  if [[ -n "${TTYD_PID:-}" ]]; then
    kill "$TTYD_PID" >/dev/null 2>&1 || true
  fi
  if [[ -n "${SSHD_PID:-}" ]]; then
    kill "$SSHD_PID" >/dev/null 2>&1 || true
  fi
}
trap cleanup EXIT

start_sshd() {
  local auth_dir="/home/debug/.ssh"
  local auth_file="$auth_dir/authorized_keys"
  local key_source=""

  install -d -m 700 -o debug -g debug "$auth_dir"

  if [[ -n "$SSH_AUTHORIZED_KEYS" ]]; then
    printf '%s\n' "$SSH_AUTHORIZED_KEYS" >"$auth_file"
    key_source='SSH_AUTHORIZED_KEYS env'
  elif [[ -f "$SSH_AUTHORIZED_KEYS_FILE" ]]; then
    cp "$SSH_AUTHORIZED_KEYS_FILE" "$auth_file"
    key_source="$SSH_AUTHORIZED_KEYS_FILE"
  else
    SSH_STATUS="waiting for authorized keys at $SSH_AUTHORIZED_KEYS_FILE"
    if [[ "$SSH_ENABLED" == "true" ]]; then
      echo "[mcp-debug] SSH_ENABLED=true but no authorized keys found (expected $SSH_AUTHORIZED_KEYS_FILE or SSH_AUTHORIZED_KEYS)" >&2
      return 1
    fi
    echo "[mcp-debug] SSH keys not found; skipping sshd startup. Set SSH_ENABLED=true to force and provide keys." >&2
    return 0
  fi

  chmod 600 "$auth_file"
  chown debug:debug "$auth_file"

  if [[ ! -f /etc/ssh/ssh_host_rsa_key ]]; then
    echo "[mcp-debug] Generating SSH host keys"
    ssh-keygen -A >/dev/null
  fi

  cat >"$SSH_CONFIG_PATH" <<CONF
Port $SSH_PORT
PasswordAuthentication no
PermitRootLogin no
AuthorizedKeysFile /home/debug/.ssh/authorized_keys
AllowUsers debug
AllowTcpForwarding no
GatewayPorts no
X11Forwarding no
ClientAliveInterval 180
ClientAliveCountMax 2
UseDNS no
CONF

  echo "[mcp-debug] Starting sshd on port $SSH_PORT (authorized keys: $key_source)"
  /usr/sbin/sshd -D -e &
  SSHD_PID=$!
  SSH_STATUS="running on port $SSH_PORT (PID ${SSHD_PID}, keys: $key_source)"
}

if [[ -n "$TAIL_FILES" ]]; then
  echo "[mcp-debug] Tailing logs: $TAIL_FILES"
  # shellcheck disable=SC2086
  tail -n0 -F $TAIL_FILES &
  TAIL_PID=$!
else
  echo "[mcp-debug] No TAIL_FILES configured. Set TAIL_FILES='/workspace/logs/*.log' to stream logs."
fi

if [[ "$TTYD_ENABLED" != "false" ]]; then
  echo "[mcp-debug] Starting ttyd web shell on port ${TTYD_PORT}"
  # shellcheck disable=SC2086
  ttyd --port "$TTYD_PORT" --interface 0.0.0.0 $TTYD_EXTRA_ARGS bash &
  TTYD_PID=$!
else
  echo "[mcp-debug] ttyd disabled (set TTYD_ENABLED=true to enable web shell)"
fi

if [[ "$SSH_ENABLED" != "false" ]]; then
  if ! start_sshd; then
    echo "[mcp-debug] Failed to start sshd"
    exit 1
  fi
else
  SSH_STATUS="disabled via SSH_ENABLED=false"
fi

cat <<'BANNER'
============================================================
 MCP Debug Helper - container is running
 Use docker exec -it mcp-debug bash  to open a shell.
 Set TAIL_FILES="/workspace/logs/*.log" (or similar) to stream
 matching files automatically to docker logs.
============================================================
BANNER

while true; do
  timestamp=$(date -Iseconds)
  recent=$(ls -1t "$LOG_DIR" 2>/dev/null | head -n 5 || true)
  echo "[${timestamp}] heartbeat :: LOG_DIR=${LOG_DIR}"
  if [[ -n "${TTYD_PID:-}" ]]; then
    echo "  ttyd status: running on port ${TTYD_PORT} (PID ${TTYD_PID})"
  else
    echo "  ttyd status: disabled"
  fi
  if [[ -n "${SSHD_PID:-}" ]]; then
    if kill -0 "$SSHD_PID" >/dev/null 2>&1; then
      echo "  sshd status: $SSH_STATUS"
    else
      echo "  sshd status: exited (check docker logs)"
    fi
  else
    echo "  sshd status: $SSH_STATUS"
  fi
  if [[ -n "$recent" ]]; then
    echo "  recent logs:" $recent
  else
    echo "  (no log files yet)"
  fi
  sleep "$HEARTBEAT_INTERVAL"
done
