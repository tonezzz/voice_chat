<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CarWatch helper</title>
    <style>
      :root {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        color: #0f172a;
        background: #f8fafc;
      }
      body {
        margin: 0 auto;
        padding: 24px;
        max-width: 560px;
      }
      h1 {
        font-size: 1.4rem;
        margin-bottom: 0.5rem;
      }
      fieldset {
        border: 1px solid #cbd5f5;
        border-radius: 8px;
        margin-bottom: 16px;
        padding: 16px;
      }
      legend {
        font-weight: 600;
        padding: 0 8px;
      }
      label {
        display: block;
        font-size: 0.9rem;
        margin-bottom: 4px;
      }
      input,
      select,
      textarea {
        width: 100%;
        box-sizing: border-box;
        padding: 8px 10px;
        border-radius: 6px;
        border: 1px solid #94a3b8;
        margin-bottom: 12px;
      }
      textarea {
        min-height: 64px;
      }
      .file-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 12px;
      }
      .file-buttons label {
        flex: 1;
        text-align: center;
        border: 1px dashed #64748b;
        color: #0f172a;
        padding: 12px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        background: #e2e8f0;
      }
      .file-buttons input {
        display: none;
      }
      button {
        width: 100%;
        padding: 12px 16px;
        font-size: 1rem;
        border-radius: 999px;
        border: none;
        background: #2563eb;
        color: white;
        font-weight: 600;
        cursor: pointer;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      img {
        width: 100%;
        border-radius: 8px;
        margin-bottom: 12px;
        display: none;
      }
      .status {
        min-height: 1.5rem;
        margin-top: 8px;
        font-size: 0.95rem;
      }
      .status.ok {
        color: #15803d;
      }
      .status.error {
        color: #b91c1c;
      }
      .row {
        display: flex;
        gap: 12px;
      }
      .row > div {
        flex: 1;
      }
    </style>
  </head>
  <body>
    <h1>CarWatch snapshot helper</h1>
    <p>Upload a still or use your phone camera. The snapshot lives for ~2 minutes.</p>

    <fieldset>
      <legend>Snapshot details</legend>
      <label for="deviceName">Device name</label>
      <input id="deviceName" value="GarageCam" />

      <div class="row">
        <div>
          <label for="connection">Connection</label>
          <select id="connection">
            <option value="online" selected>Online</option>
            <option value="connecting">Connecting</option>
            <option value="offline">Offline</option>
          </select>
        </div>
        <div>
          <label for="battery">Battery %</label>
          <input id="battery" type="number" min="0" max="100" value="82" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="temperature">Temperature °C</label>
          <input id="temperature" type="number" value="31" />
        </div>
        <div>
          <label for="fps">FPS</label>
          <input id="fps" type="number" value="24" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="latency">Latency (ms)</label>
          <input id="latency" type="number" value="220" />
        </div>
        <div>
          <label for="streamUrl">Stream URL</label>
          <input id="streamUrl" value="https://example.com/live" />
        </div>
      </div>

      <label for="thumbUrl">Thumbnail URL</label>
      <input id="thumbUrl" placeholder="https://…" />

      <label for="detections">Detections (one per line: label,count,confidence)</label>
      <textarea id="detections" placeholder="Sedan,2,0.87
SUV,1,0.73"></textarea>

      <label for="events">Events (one per line: type|label|detail)</label>
      <textarea id="events" placeholder="entry|Gate A|Blue sedan detected"></textarea>
    </fieldset>

    <fieldset>
      <legend>Snapshot image</legend>
      <div class="file-buttons">
        <label>
          Capture photo
          <input id="cameraInput" type="file" accept="image/*" capture="environment" />
        </label>
        <label>
          Choose from library
          <input id="libraryInput" type="file" accept="image/*" />
        </label>
      </div>
      <img id="preview" alt="Preview" />
    </fieldset>

    <button id="submitBtn" disabled>Send snapshot</button>
    <div id="status" class="status"></div>

    <script>
      const cameraInput = document.getElementById('cameraInput');
      const libraryInput = document.getElementById('libraryInput');
      const submitBtn = document.getElementById('submitBtn');
      const preview = document.getElementById('preview');
      const statusEl = document.getElementById('status');
      let imageBase64 = '';

      const readImage = (file) =>
        new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });

      const handleFile = async (event) => {
        const file = event.target.files?.[0];
        if (!file) return;
        submitBtn.disabled = true;
        statusEl.textContent = 'Encoding image…';
        statusEl.className = 'status';
        try {
          imageBase64 = await readImage(file);
          preview.src = imageBase64;
          preview.style.display = 'block';
          submitBtn.disabled = false;
          statusEl.textContent = '';
        } catch (err) {
          console.error(err);
          statusEl.textContent = 'Failed to read image';
          statusEl.className = 'status error';
        }
      };

      cameraInput.addEventListener('change', handleFile);
      libraryInput.addEventListener('change', handleFile);

      const parseDetections = () => {
        const raw = document.getElementById('detections').value.trim();
        if (!raw) return [];
        return raw.split(/\n+/).map((line, index) => {
          const [label, count, confidence] = line.split(',').map((p) => p.trim());
          return {
            label: label || `Detection ${index + 1}`,
            count: Number(count) || 1,
            confidence: Number(confidence) || 0.9
          };
        });
      };

      const parseEvents = () => {
        const raw = document.getElementById('events').value.trim();
        if (!raw) return [];
        return raw.split(/\n+/).map((line, index) => {
          const [type = 'entry', label = `Event ${index + 1}`, detail = ''] = line
            .split('|')
            .map((p) => p.trim());
          return { type, label, detail, timestamp: new Date().toISOString() };
        });
      };

      const payloadFromForm = () => ({
        deviceName: document.getElementById('deviceName').value.trim() || 'CarWatch device',
        connection: document.getElementById('connection').value,
        batteryPercent: Number(document.getElementById('battery').value) || null,
        temperatureC: Number(document.getElementById('temperature').value) || null,
        fps: Number(document.getElementById('fps').value) || null,
        latencyMs: Number(document.getElementById('latency').value) || null,
        streamUrl: document.getElementById('streamUrl').value.trim(),
        thumbUrl: document.getElementById('thumbUrl').value.trim(),
        imageBase64,
        detections: parseDetections(),
        events: parseEvents(),
        timestamp: new Date().toISOString()
      });

      const apiBase = window.location.origin.replace(/\/$/, '');

      submitBtn.addEventListener('click', async () => {
        if (!imageBase64) {
          statusEl.textContent = 'Select an image first';
          statusEl.className = 'status error';
          return;
        }
        submitBtn.disabled = true;
        statusEl.textContent = 'Sending snapshot…';
        statusEl.className = 'status';
        try {
          const response = await fetch(`${apiBase}/carwatch/snapshot`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payloadFromForm())
          });
          const data = await response.json();
          if (!response.ok) {
            throw new Error(data?.error || 'upload_failed');
          }
          statusEl.textContent = 'Snapshot sent! Switch back to the main UI to view it.';
          statusEl.className = 'status ok';
        } catch (err) {
          console.error(err);
          statusEl.textContent = `Failed: ${err.message || err}`;
          statusEl.className = 'status error';
        } finally {
          submitBtn.disabled = false;
        }
      });
    </script>
  </body>
</html>
